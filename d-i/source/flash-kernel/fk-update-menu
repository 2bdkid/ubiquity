#!/bin/sh

set -e

_FK_MENU_DIRECTORY="/boot"

Update ()
{
	 # Upate target file using source content
	_TARGET="${1}"
	_SOURCE="${2}"

	_TMPFILE="${_TARGET}.tmp"
	rm -f "${_TMPFILE}"

	echo "${_SOURCE}" > "${_TMPFILE}"

	if [ -e "${_TARGET}" ] && cmp -s "${_TARGET}" "${_TMPFILE}"
	then
		rm -f "${_TMPFILE}"
	else
		# FIXME: should use fsync here
		echo "P: Updating ${_TARGET}..."
		mv -f "${_TMPFILE}" "${_TARGET}"
	fi
}

# User is unprivileged
if [ "$(id -u)" -ne 0 ]
then
	echo "E: need root privileges"
	exit 1
fi

# Redirect stdout to stderr due Debconf usage
exec 1>&2

# Reading the default file
if [ -e /etc/flash-kernel.conf ]
then
	. /etc/flash-kernel.conf
fi
if [ -e /etc/fk-menu.conf ]
then
	. /etc/fk-menu.conf
fi

FK_MENU_UPDATE="${FK_MENU_UPDATE:-true}"

if [ "${FK_MENU_UPDATE}" != "true" ]
then
	echo "P: fk-update-menu is disabled in /etc/flash-kernel.conf."

	exit 0
fi

# Checking extlinux directory
echo -n "P: Checking for FK_MENU_DIRECTORY directory..."

# Creating extlinux directory
if [ ! -e "${_FK_MENU_DIRECTORY}" ]
then
	echo " not found."

	echo -n "P: Creating FK_MENU_UPDATE directory..."
	mkdir -p "${_FK_MENU_DIRECTORY}"
	echo " done: ${_FK_MENU_DIRECTORY}"
else
	echo " found."
fi

# Setting defaults
FK_MENU_ALTERNATIVES="${FK_MENU_ALTERNATIVES:-default recovery}"
FK_MENU_DEFAULT="${FK_MENU_DEFAULT:-l0}"
FK_MENU_ENTRIES="${FK_MENU_ENTRIES:-all}"
FK_MENU_MEMDISK="${FK_MENU_MEMDISK:-true}"
FK_MENU_MEMDISK_DIRECTORY="${FK_MENU_MEMDISK_DIRECTORY:-/boot}"

if [ -z "${FK_MENU_MENU_LABEL}" ]
then
	if [ -x "$(which lsb_release 2>/dev/null)" ]
	then
		FK_MENU_MENU_LABEL="$(lsb_release -i -s) GNU/Linux, kernel"
	else
		FK_MENU_MENU_LABEL="Ubuntu GNU/Linux, kernel"
	fi
fi

FK_MENU_OS_PROBER="${FK_MENU_OS_PROBER:-true}"
FK_MENU_PARAMETERS="${FK_MENU_PARAMETERS:-ro quiet}"

if [ -z "${FK_MENU_ROOT}" ]
then
	# Find root partition
	while read _LINE
	do

read _FS_SPEC _FS_FILE _FS_VFSTYPE _FS_MNTOPS _FS_FREQ _FS_PASSNO << EOF
${_LINE}
EOF

		if [ "${_FS_SPEC}" != "#" ] && [ "${_FS_FILE}" = "/" ]
		then
			FK_MENU_ROOT="root=${_FS_SPEC}"
			break
		fi
	done < /etc/fstab
fi

if [ -z "${FK_MENU_THEME}" ]
then
	# Using default menu if available
	if [ -e /usr/share/syslinux/themes/debian/extlinux ]
	then
		FK_MENU_THEME="debian"
	else
		FK_MENU_THEME="none"
	fi
fi

FK_MENU_TIMEOUT="${FK_MENU_TIMEOUT:-50}"

# Writing new default file
cat > "/etc/fk-menu.conf" << EOF
## /etc/fk-menu.conf - configuration file for fk-menu-update(8)

FK_MENU_UPDATE="${FK_MENU_UPDATE}"

FK_MENU_ALTERNATIVES="${FK_MENU_ALTERNATIVES}"
FK_MENU_DEFAULT="${FK_MENU_DEFAULT}"
FK_MENU_ENTRIES="${FK_MENU_ENTRIES}"
FK_MENU_MEMDISK="${FK_MENU_MEMDISK}"
FK_MENU_MEMDISK_DIRECTORY="${FK_MENU_MEMDISK_DIRECTORY}"
FK_MENU_MENU_LABEL="${FK_MENU_MENU_LABEL}"
FK_MENU_OS_PROBER="${FK_MENU_OS_PROBER}"
FK_MENU_PARAMETERS="${FK_MENU_PARAMETERS}"
FK_MENU_ROOT="${FK_MENU_ROOT}"
FK_MENU_THEME="${FK_MENU_THEME}"
FK_MENU_TIMEOUT="${FK_MENU_TIMEOUT}"
EOF

# Create boot.cfg
_CONFIG="\
## ${_FK_MENU_DIRECTORY}/boot.cfg
##
## IMPORTANT WARNING
##
## The configuration of this file is generated automatically.
## Do not edit this file manually, use: fk-menu-update


"

# Find linux versions
_VERSIONS="$(cd /boot && ls vmlinuz-* | grep -v .dpkg-tmp | sed -e 's|vmlinuz-||g' | sort -nr)"

if [ "$(stat --printf %d /)" = "$(stat --printf %d /boot)" ]
then
	# / and /boot are on the same filesystem
	_BOOT_DIRECTORY="/boot"
else
	# / and /boot are not on the same filesystem
	_BOOT_DIRECTORY=""
fi


for _VERSION in ${_VERSIONS}
do
	echo "P: Writing config for /boot/vmlinuz-${_VERSION}..."

	_NUMBER="${_NUMBER:-0}"
	_ENTRY="${_ENTRY:-1}"

	if [ -e /boot/initrd.img-${_VERSION} ]
	then
		_INITRD="initrd=${_BOOT_DIRECTORY}/initrd.img-${_VERSION}"
	else
		_INITRD=""
	fi

	if echo ${FK_MENU_ALTERNATIVES} | grep -q default
	then

	# Writing default entry
	_CONFIG="${_CONFIG}

label l${_NUMBER}
	menu label ${FK_MENU_MENU_LABEL} ${_VERSION}
	linux ${_BOOT_DIRECTORY}/vmlinuz-${_VERSION}
	append ${_INITRD} ${FK_MENU_ROOT} ${FK_MENU_PARAMETERS}"

	fi

	if echo ${FK_MENU_ALTERNATIVES} | grep -q live
	then

	# Writing live entry
	_CONFIG="${_CONFIG}

label l${_NUMBER}l
	menu label ${FK_MENU_MENU_LABEL} ${_VERSION} (live mode)
	linux ${_BOOT_DIRECTORY}/vmlinuz-${_VERSION}
	append ${_INITRD} ${FK_MENU_ROOT} ${FK_MENU_PARAMETERS} boot=live plainroot
	text help
   This option boots the system into live mode (non-persistent)
	endtext"

	fi

	if echo ${FK_MENU_ALTERNATIVES} | grep -q recovery
	then

	# Writing recovery entry
	_CONFIG="${_CONFIG}

label l${_NUMBER}r
	menu label ${FK_MENU_MENU_LABEL} ${_VERSION} (recovery mode)
	linux ${_BOOT_DIRECTORY}/vmlinuz-${_VERSION}
	append ${_INITRD} ${FK_MENU_ROOT} $(echo ${FK_MENU_PARAMETERS} | sed -e 's| quiet||') single
	text help
   This option boots the system into recovery mode (single-user)
	endtext"

	fi

	_NUMBER="$((${_NUMBER} + 1))"

	if [ "${FK_MENU_ENTRIES}" = "${_ENTRY}" ]
	then
		break
	fi
done

_NUMBER=""

Update "${_FK_MENU_DIRECTORY}/boot.cfg" "${_CONFIG}"

